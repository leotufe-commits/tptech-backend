generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////
// JOYERÍA (EMPRESA)
//////////////////////////////
model Jewelry {
  id        String @id @default(cuid())
  name      String
  firstName String
  lastName  String

  phoneCountry String
  phoneNumber  String
  street       String
  number       String
  city         String
  province     String
  postalCode   String
  country      String

  // Datos fiscales / empresa
  logoUrl      String @default("")
  legalName    String @default("")
  cuit         String @default("")
  ivaCondition String @default("")
  email        String @default("")
  website      String @default("")
  notes        String @default("")

  // ✅ Cambio rápido de usuario (PIN) dentro del sistema
  quickSwitchEnabled         Boolean @default(false)
  pinLockEnabled             Boolean @default(false)
  pinLockTimeoutSec          Int     @default(120)
  pinLockRequireOnUserSwitch Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs   AuditLog[]
  roles       Role[]
  users       User[]
  warehouses  Warehouse[]
  attachments JewelryAttachment[]

  // ✅ Catálogos administrables (relación inversa)
  catalogItems CatalogItem[]

  @@index([createdAt])
}

//////////////////////////////
// ADJUNTOS DE EMPRESA
//////////////////////////////
model JewelryAttachment {
  id        String  @id @default(cuid())
  jewelryId String
  jewelry   Jewelry @relation(fields: [jewelryId], references: [id], onDelete: Cascade)

  url      String
  filename String
  mimeType String
  size     Int

  createdAt DateTime @default(now())

  @@index([jewelryId])
  @@index([createdAt])
}

//////////////////////////////
// ALMACENES
//////////////////////////////
model Warehouse {
  id        String  @id @default(cuid())
  jewelryId String
  name      String
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jewelry        Jewelry @relation(fields: [jewelryId], references: [id], onDelete: Cascade)
  favoredByUsers User[]  @relation("UserFavoriteWarehouse")

  @@unique([jewelryId, name])
  @@index([jewelryId])
  @@index([jewelryId, isActive])
}

//////////////////////////////
// USUARIOS
//////////////////////////////
model User {
  id       String     @id @default(cuid())
  email    String
  password String
  name     String?
  status   UserStatus @default(ACTIVE)

  tokenVersion Int @default(0)

  avatarUrl String?
  jewelryId String

  // ⭐ ALMACÉN FAVORITO
  favoriteWarehouseId String?

  // ✅ SOFT DELETE
  deletedAt DateTime?

  // Datos personales
  phoneCountry   String @default("")
  phoneNumber    String @default("")
  documentType   String @default("")
  documentNumber String @default("")
  street         String @default("")
  number         String @default("")
  city           String @default("")
  province       String @default("")
  postalCode     String @default("")
  country        String @default("")
  notes          String @default("")

  // ✅ CLAVE RÁPIDA (PIN)
  quickPinHash        String?
  quickPinEnabled     Boolean   @default(false)
  quickPinUpdatedAt   DateTime?
  quickPinFailedCount Int       @default(0)
  quickPinLockedUntil DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relaciones
  jewelry           Jewelry    @relation(fields: [jewelryId], references: [id], onDelete: Cascade)
  favoriteWarehouse Warehouse? @relation("UserFavoriteWarehouse", fields: [favoriteWarehouseId], references: [id])

  roles               UserRole[]
  permissionOverrides UserPermissionOverride[]
  attachments         UserAttachment[]
  auditLogs           AuditLog[]

  // ✅ NUEVO: tokens (reset/invite) single-use
  authTokens AuthToken[]

  @@unique([jewelryId, email])
  @@index([jewelryId])
  @@index([jewelryId, status])
  @@index([favoriteWarehouseId])
  @@index([jewelryId, deletedAt])
  @@index([quickPinUpdatedAt])
  @@index([quickPinEnabled])
}

//////////////////////////////
// ✅ AUTH TOKENS (RESET / INVITE) - single-use
//////////////////////////////
model AuthToken {
  id        String   @id @default(cuid())
  userId    String
  purpose   String   // "RESET" | "INVITE"
  jti       String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, purpose])
  @@index([expiresAt])
}

//////////////////////////////
// ADJUNTOS DE USUARIO
//////////////////////////////
model UserAttachment {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  url      String
  filename String
  mimeType String
  size     Int

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
}

//////////////////////////////
// ROLES / PERMISOS
//////////////////////////////
model Role {
  id          String    @id @default(cuid())
  jewelryId   String
  name        String
  displayName String?
  isSystem    Boolean   @default(false)
  deletedAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jewelry     Jewelry          @relation(fields: [jewelryId], references: [id], onDelete: Cascade)
  permissions RolePermission[]
  users       UserRole[]

  @@unique([jewelryId, name])
  @@index([jewelryId])
  @@index([jewelryId, deletedAt])
}

model Permission {
  id        String     @id @default(cuid())
  module    PermModule
  action    PermAction
  createdAt DateTime   @default(now())

  roles     RolePermission[]
  overrides UserPermissionOverride[]

  @@unique([module, action])
  @@index([module])
}

model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@index([roleId])
}

model UserPermissionOverride {
  id           String         @id @default(cuid())
  userId       String
  permissionId String
  effect       OverrideEffect

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([permissionId])
}

//////////////////////////////
// AUDITORÍA
//////////////////////////////
model AuditLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  action    String
  success   Boolean
  userId    String?
  jewelryId String?
  ip        String?
  userAgent String?
  meta      Json?

  user    User?    @relation(fields: [userId], references: [id])
  jewelry Jewelry? @relation(fields: [jewelryId], references: [id])

  @@index([createdAt])
  @@index([action])
  @@index([success])
  @@index([jewelryId, createdAt])
  @@index([userId, createdAt])
}

//////////////////////////////
// ENUMS
//////////////////////////////
enum UserStatus {
  ACTIVE
  PENDING
  BLOCKED
}

enum PermModule {
  USERS_ROLES
  INVENTORY
  MOVEMENTS
  CLIENTS
  SALES
  SUPPLIERS
  PURCHASES
  CURRENCIES
  COMPANY_SETTINGS
  REPORTS
  WAREHOUSES
  PROFILE
}

enum PermAction {
  VIEW
  CREATE
  EDIT
  DELETE
  EXPORT
  ADMIN
}

enum OverrideEffect {
  ALLOW
  DENY
}

//////////////////////////////
// CATÁLOGOS (COMBOS ADMINISTRABLES)
//////////////////////////////
enum CatalogType {
  IVA_CONDITION
  PHONE_PREFIX
  DOCUMENT_TYPE
  CITY
  PROVINCE
  COUNTRY
}

model CatalogItem {
  id        String      @id @default(cuid())
  jewelryId String
  type      CatalogType
  label     String
  isActive  Boolean     @default(true)
  sortOrder Int         @default(0)

  // ✅ NUEVO: favorito por tipo (1 por type)
  isFavorite Boolean    @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  jewelry Jewelry @relation(fields: [jewelryId], references: [id], onDelete: Cascade)

  @@index([jewelryId])
  @@index([jewelryId, type, isActive])
  @@index([jewelryId, type, isFavorite]) // opcional pero útil
  @@unique([jewelryId, type, label])
}
